# VoiceInput

本專案為 macOS 上的語音輸入工具，主要功能為透過語音輸入文字，並將文字輸入到指定的應用程式中。

比對目標: VoiceInk App (<https://github.com/Beingpax/VoiceInk>)

## 開發過程

- Always reply in zh-TW.
- Thinking in zh-TW.
- Display thinking process in zh-TW.
- Display message in zh-TW.
- 嚴禁使用 zh-CN 簡體中文

## 核心功能

- 透過語音輸入文字
- 將文字輸入到指定的應用程式中
- 支援多種語言
- 支援多種輸入方式
- 支援多種輸出方式
- 支援指定快捷鍵
- 使用 whisper 進行語音辨識
- 可指定 whisper 模型
- Optional: 使用 LLM 進行文字修正

## 詳細實作規格 (2026-02-14 更新)

### 1. 設定與 UI 介面

- **啟動視窗**: 提供完整的設定介面，包含：
  - **辨識語言**: 支援繁體中文 (zh-TW)、簡體中文 (zh-CN)、英文 (en-US) 與日文 (ja-JP)。
  - **模型設定**: 可自訂 Whisper 模型路徑 (`.bin` 檔案)。若路徑為空，則預設採用 Apple 系統內建語音辨識服務。
  - **自動插入**: 可切換轉錄完成後是否自動將文字輸出至當前作用中的應用程式。
- **浮動狀態面板**: 錄音時會自動顯示膠囊狀的浮動視窗，顯示即時辨識結果與動態波形圖示，錄音結束後自動隱藏。

### 2. 快捷鍵邏輯

- **預設快捷鍵**: 使用 `fn` 鍵作為單鍵觸發器。
- **操作流程**:
    1. 按下 `fn` 鍵：開始錄音，顯示浮動視窗。
    2. 再次按下 `fn` 鍵：停止錄音，開始最終轉錄。
- **全域監聽**: 使用 `NSEvent` 監聽全域修飾鍵變動 (`flagsChanged`)，確保在任何應用程式中都能觸發。

### 3. 文字轉錄與輸出

- **即時回饋**: 錄音期間即時更新部分辨識結果，顯示於浮動面板。
- **自動輸出**: 轉錄完成後，透過 `InputSimulator` (CGEvent 模擬) 將結果文字精準插入到先前使用者所在的輸入框。
- **延遲處理**: 轉錄結束與隱藏視窗之間設有微量延遲，確保使用者能確認最終文字結果。

### 4. SwiftUI 架構與持久化設定

- **嚴格使用 `@AppStorage`**: 專案中的 ViewModel 負責持久化狀態儲存時，**必須** 使用 SwiftUI 提供的 `@AppStorage` 標籤，以維持宣告式的資料綁定與自動同步機制。
- **禁止擅自拔除設計**: 嚴格禁止未來的 AI 代理人為了規避初始化時序問題（Timing / Scope Lifecycle）或解決 Swift 並發警告（Concurrency warnings）而擅自將 `@AppStorage` 拔除並退化為傳統的 `UserDefaults.set` 寫法。遇到此類問題時，必須針對「讀寫時序邏輯」與「依賴順序」進行解耦合設計，而不是破壞原有的宣告式存儲架構。

